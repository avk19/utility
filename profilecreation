# recipes/default.rb

# Define the variable, user, and the profile file
user_name = 'target_user'
variable_name = 'MY_VARIABLE'
variable_value = 'my_value'
profile_file = "/home/#{user_name}/.bash_profile"

ruby_block 'Add environment variable to user profile' do
  block do
    file = Chef::Util::FileEdit.new(profile_file)
    # Check if the variable is already present
    unless file.search_line(/#{variable_name}=/)
      file.insert_line_if_no_match(/#{variable_name}=/, "export #{variable_name}=#{variable_value}")
      file.write_file
    end
  end
  not_if "grep -q '^export #{variable_name}=#{variable_value}' #{profile_file}", :user => user_name
end